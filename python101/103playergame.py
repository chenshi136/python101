import requests
import json
import random

def call_zhipu_api(messages, model="glm-4-flash"):
    url = "https://open.bigmodel.cn/api/paas/v4/chat/completions"

    headers = {
        "Authorization": "2adee399653141a9a95bb4480dd4602d.MBtlVqTs0ZTX25r8",
        "Content-Type": "application/json"
    }

    data = {
        "model": model,
        "messages": messages,
        "temperature": 1.0
    }

    response = requests.post(url, headers=headers, json=data)

    if response.status_code == 200:
        return response.json()
    else:
        raise Exception(f"APIè°ƒç”¨å¤±è´¥: {response.status_code}, {response.text}")


# ========== æ¸¸æˆè®¾ç½®ï¼šå«Œç–‘äººåˆ—è¡¨ ==========
suspects = [
    {
        "name": "ç®¡å®¶è€ç‹",
        "description": "ä¸€ä¸ª50å¤šå²çš„ç®¡å®¶ï¼Œåœ¨åºœä¸Šå·¥ä½œäº†20å¹´ï¼Œå¿ è¯šè€å®ä½†æœ€è¿‘å› ä¸ºå„¿å­æ¬ å€ºè€Œç»æµå›°éš¾ã€‚æ¡ˆå‘æ—¶å£°ç§°åœ¨æ•´ç†è´¦æœ¬ï¼Œä½†æ²¡äººèƒ½è¯æ˜ã€‚",
        "personality": "ç¨³é‡ã€è°¨æ…ã€è¯ä¸å¤šï¼Œä½†çœ¼ç¥ä¸­å¸¦ç€ç„¦è™‘"
    },
    {
        "name": "å°å§çš„è´´èº«ä¸«é¬Ÿå°ç¿ ",
        "description": "18å²çš„ä¸«é¬Ÿï¼Œèªæ˜ä¼¶ä¿ï¼Œæ·±å¾—å°å§ä¿¡ä»»ã€‚ä½†å¥¹æš—æ‹åºœä¸Šçš„æ•™ä¹¦å…ˆç”Ÿï¼Œè€Œæ•™ä¹¦å…ˆç”Ÿæœ€è¿‘å’Œå°å§èµ°å¾—å¾ˆè¿‘ã€‚æ¡ˆå‘æ—¶å¥¹è¯´è‡ªå·±åœ¨å¨æˆ¿å‡†å¤‡èŒ¶ç‚¹ã€‚",
        "personality": "æœºæ•ã€å–„äºè§‚å¯Ÿï¼Œä½†æœ‰æ—¶ä¼šéšè—çœŸå®æƒ³æ³•ï¼Œè¯´è¯æ—¶ä¼šä¸ç»æ„åœ°é€éœ²çº¿ç´¢"
    },
    {
        "name": "æ•™ä¹¦å…ˆç”Ÿå¼ ç§€æ‰",
        "description": "25å²çš„å¹´è½»ä¹¦ç”Ÿï¼Œæ¥åºœä¸Šæ•™ä¹¦æ‰3ä¸ªæœˆã€‚å®¶å¢ƒè´«å¯’ä½†æ‰å­¦å‡ºä¼—ï¼Œå’Œå°å§äº’ç”Ÿæƒ…æ„«ã€‚æ¡ˆå‘æ—¶ä»–è¯´åœ¨ä¹¦æˆ¿è¯»ä¹¦ï¼Œä½†ä¸«é¬Ÿå°ç¿ è¯´çœ‹åˆ°äº†ä»–ã€‚",
        "personality": "æ¸©æ–‡å°”é›…ã€æœ‰å­¦è¯†ï¼Œä½†é¢å¯¹è¿½é—®æ—¶ä¼šæ˜¾å¾—æœ‰äº›ç´§å¼ ï¼Œä¼šå¼•ç”¨è¯—è¯æ¥æ©é¥°"
    },
    {
        "name": "å¨å¨˜æå©¶",
        "description": "40å¤šå²çš„å¨å¨˜ï¼Œæ€§æ ¼æ³¼è¾£ï¼Œåœ¨åºœä¸Šå·¥ä½œ10å¹´ã€‚æœ€è¿‘å› ä¸ºå°å§æ‰¹è¯„å¥¹çš„èœå¤ªå’¸è€Œå¿ƒç”Ÿä¸æ»¡ã€‚æ¡ˆå‘æ—¶å¥¹åœ¨å¨æˆ¿ï¼Œä½†æœ‰äººå¬åˆ°å¥¹å’Œäººäº‰åµçš„å£°éŸ³ã€‚",
        "personality": "ç›´çˆ½ã€æœ‰äº›æ€¥èºï¼Œè¯´è¯å—“é—¨å¤§ï¼Œå®¹æ˜“æ¿€åŠ¨æ—¶ä¼šé€éœ²ä¿¡æ¯"
    },
    {
        "name": "æŠ¤é™¢æ­¦å¸ˆèµµåˆš",
        "description": "30å²çš„æ­¦å¸ˆï¼Œè´Ÿè´£åºœä¸Šçš„å®‰å…¨ã€‚æ­¦åŠŸé«˜å¼ºä½†æ€§æ ¼æš´èºï¼Œæ›¾ç»å› ä¸ºå°å§æ‹’ç»ä»–çš„æ±‚çˆ±è€Œå¿ƒæ€€ä¸æ»¡ã€‚æ¡ˆå‘æ—¶ä»–åœ¨å·¡è§†ï¼Œä½†æ²¡äººçœ‹åˆ°ä»–ã€‚",
        "personality": "åˆšçƒˆã€ç›´æ¥ç›´å»ï¼Œè¯´è¯æœ‰æ±Ÿæ¹–æ°”ï¼Œä¸å–œæ¬¢è¢«æ€€ç–‘"
    }
]

# ========== éšæœºé€‰æ‹©çœŸå‡¶ ==========
murderer = random.choice(suspects)
murderer_name = murderer["name"]

print("=" * 60)
print("ğŸ” æŠ“çœŸå‡¶æ¸¸æˆ ğŸ”")
print("=" * 60)
print("\nã€æ¸¸æˆè§„åˆ™ã€‘")
print("1. åºœä¸Šå‘ç”Ÿäº†ä¸€èµ·ç›—çªƒæ¡ˆï¼Œæœ‰5ä¸ªå«Œç–‘äºº")
print("2. ä½ å¯ä»¥é€šè¿‡æé—®æ¥æ”¶é›†çº¿ç´¢å’Œè¯æ®")
print("3. æ¯ä¸ªå«Œç–‘äººä¼šæ ¹æ®ä»–ä»¬çš„æ€§æ ¼ç‰¹ç‚¹å›ç­”ä½ çš„é—®é¢˜")
print("4. ä»”ç»†è§‚å¯Ÿä»–ä»¬çš„å›ç­”ï¼Œæ‰¾å‡ºçŸ›ç›¾å’Œçº¿ç´¢")
print("5. å½“ä½ ç¡®å®šçœŸå‡¶æ—¶ï¼Œå¯ä»¥è¯´ï¼š'çœŸå‡¶æ˜¯XXX' æˆ– 'æˆ‘è®¤ä¸ºçœŸå‡¶æ˜¯XXX'")
print("6. å¦‚æœçŒœå¯¹äº†ï¼Œæ¸¸æˆç»“æŸï¼å¦‚æœçŒœé”™äº†ï¼Œç»§ç»­æé—®ã€‚")
print("\nã€å«Œç–‘äººåå•ã€‘")
for i, suspect in enumerate(suspects, 1):
    print(f"{i}. {suspect['name']} - {suspect['description']}")
print("\n" + "=" * 60)
print("å¼€å§‹è°ƒæŸ¥ï¼ä½ å¯ä»¥è¯¢é—®ä»»ä½•å«Œç–‘äººé—®é¢˜ã€‚")
print("æç¤ºï¼šä½ å¯ä»¥é—®'ä½ æ¡ˆå‘æ—¶åœ¨å“ªé‡Œï¼Ÿ'ã€'ä½ æœ€è¿‘æœ‰ä»€ä¹ˆå›°éš¾å—ï¼Ÿ'ç­‰é—®é¢˜")
print("=" * 60 + "\n")

# ========== Prompt Engineering: è®¾è®¡ç³»ç»Ÿæç¤ºè¯ ==========
system_prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¾¦æ¢æ¸¸æˆçš„AIåŠ©æ‰‹ã€‚åœ¨è¿™ä¸ªæ¸¸æˆä¸­ï¼Œæœ‰ä¸€ä¸ªçœŸå‡¶éœ€è¦è¢«æ‰¾å‡ºã€‚

ã€é‡è¦ä¿¡æ¯ã€‘ï¼ˆåªæœ‰ä½ çŸ¥é“ï¼Œä¸è¦ç›´æ¥å‘Šè¯‰ç©å®¶ï¼‰ï¼š
- çœŸå‡¶æ˜¯ï¼š{murderer_name}
- çœŸå‡¶çš„å®Œæ•´ä¿¡æ¯ï¼š{murderer['description']}
- çœŸå‡¶çš„æ€§æ ¼ç‰¹ç‚¹ï¼š{murderer['personality']}

ã€æ¸¸æˆæœºåˆ¶ã€‘ï¼š
1. ç©å®¶ä¼šå‘ä½ æé—®ï¼Œè¯¢é—®ä¸åŒçš„å«Œç–‘äºº
2. å½“ç©å®¶è¯¢é—®æŸä¸ªå«Œç–‘äººæ—¶ï¼Œä½ éœ€è¦ä»¥è¯¥å«Œç–‘äººçš„èº«ä»½å’Œæ€§æ ¼å›ç­”
3. çœŸå‡¶çš„å›ç­”åº”è¯¥åŒ…å«ä¸€äº›çŸ›ç›¾ã€ç´§å¼ æˆ–å¯ç–‘ä¹‹å¤„ï¼ˆä½†è¦å·§å¦™ï¼Œä¸èƒ½å¤ªæ˜æ˜¾ï¼‰
4. å…¶ä»–æ— è¾œè€…çš„å›ç­”åº”è¯¥æ›´åŠ è‡ªç„¶ã€ä¸€è‡´
5. çœŸå‡¶å¯èƒ½ä¼šï¼š
   - ç¼–é€ ä¸åœ¨åœºè¯æ˜
   - è½¬ç§»æ³¨æ„åŠ›åˆ°å…¶ä»–äººèº«ä¸Š
   - å›ç­”æ—¶æ˜¾å¾—ç´§å¼ æˆ–çŸ›ç›¾
   - åœ¨æŸäº›ç»†èŠ‚ä¸Šå«ç³Šä¸æ¸…
6. æ— è¾œè€…ä¼šï¼š
   - æä¾›çœŸå®å¯ä¿¡çš„ä¿¡æ¯
   - å¯èƒ½æä¾›æœ‰ç”¨çš„çº¿ç´¢
   - å›ç­”æ›´åŠ å¦ç„¶

ã€å›ç­”æ ¼å¼ã€‘ï¼š
- å¦‚æœæ˜¯è¯¢é—®å«Œç–‘äººï¼šä»¥"[å«Œç–‘äººåå­—]ï¼š"å¼€å¤´ï¼Œç„¶åç”¨ç¬¬ä¸€äººç§°ä»¥è¯¥å«Œç–‘äººçš„èº«ä»½å›ç­”
- å¦‚æœç©å®¶çŒœæµ‹çœŸå‡¶ï¼šåˆ¤æ–­æ˜¯å¦çŒœå¯¹ï¼Œå¦‚æœçŒœå¯¹äº†ï¼Œå›å¤ï¼š"ğŸ¯ æ­å–œä½ ï¼çœŸå‡¶ç¡®å®æ˜¯{murderer_name}ï¼ä½ æˆåŠŸç ´æ¡ˆäº†ï¼" å¦‚æœçŒœé”™äº†ï¼Œå›å¤ï¼š"âŒ ä¸å¯¹ï¼Œ{murderer_name}ä¸æ˜¯çœŸå‡¶ã€‚ç»§ç»­è°ƒæŸ¥å§ã€‚"

ã€ç¤ºä¾‹ã€‘ï¼š
ç©å®¶ï¼š"ç®¡å®¶è€ç‹ï¼Œä½ æ¡ˆå‘æ—¶åœ¨å“ªé‡Œï¼Ÿ"
ä½ ï¼š"ç®¡å®¶è€ç‹ï¼šæˆ‘åœ¨æ•´ç†è´¦æœ¬...å’³å’³...åœ¨ä¹¦æˆ¿é‡Œï¼Œä¸€ç›´æ²¡ç¦»å¼€è¿‡ã€‚è€çˆ·å¯ä»¥ä½œè¯...ä¸ï¼Œæˆ‘æ˜¯è¯´ï¼Œåº”è¯¥æœ‰äººçœ‹åˆ°æˆ‘çš„ã€‚"

ç°åœ¨ï¼Œç©å®¶å¼€å§‹è°ƒæŸ¥äº†ã€‚"""

# ========== åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨ï¼ˆä¿å­˜å¯¹è¯å†å²ï¼‰==========
messages = [
    {"role": "system", "content": system_prompt}
]

# ========== æ¸¸æˆä¸»å¾ªç¯ ==========
game_over = False

while not game_over:
    user_input = input("ä½ ï¼š").strip()
    
    # æ£€æŸ¥æ˜¯å¦è¦é€€å‡º
    if user_input in ["é€€å‡º", "ç»“æŸ", "ä¸ç©äº†"]:
        print("\næ¸¸æˆç»“æŸã€‚çœŸå‡¶å…¶å®æ˜¯ï¼š" + murderer_name)
        print(f"çœŸå‡¶çš„å®Œæ•´ä¿¡æ¯ï¼š{murderer['description']}\n")
        break
    
    # å°†ç”¨æˆ·è¾“å…¥æ·»åŠ åˆ°æ¶ˆæ¯å†å²
    messages.append({"role": "user", "content": user_input})
    
    # è°ƒç”¨API
    result = call_zhipu_api(messages)
    ai_response = result["choices"][0]["message"]["content"]
    
    # å°†AIå›å¤æ·»åŠ åˆ°æ¶ˆæ¯å†å²
    messages.append({"role": "assistant", "content": ai_response})
    
    # æ˜¾ç¤ºAIå›å¤
    print(f"\n{ai_response}\n")
    
    # ========== åˆ¤æ–­æ˜¯å¦çŒœå¯¹çœŸå‡¶ ==========
    # æ£€æŸ¥AIå›å¤ä¸­æ˜¯å¦åŒ…å«æˆåŠŸçŒœå¯¹çš„æ ‡è¯†
    if "ğŸ¯" in ai_response or "æ­å–œä½ " in ai_response or "æˆåŠŸç ´æ¡ˆ" in ai_response:
        print("=" * 60)
        print("ğŸ‰ æ¸¸æˆèƒœåˆ©ï¼")
        print("=" * 60)
        game_over = True
        break
    
    # å¦‚æœç©å®¶ç›´æ¥è¯´"çœŸå‡¶æ˜¯XXX"ï¼Œä¹Ÿæ£€æŸ¥ä¸€ä¸‹
    guess_keywords = ["çœŸå‡¶æ˜¯", "çœŸå‡¶å°±æ˜¯", "çœŸå‡¶è‚¯å®šæ˜¯", "æˆ‘è®¤ä¸ºçœŸå‡¶æ˜¯", "æˆ‘çŒœçœŸå‡¶æ˜¯"]
    for keyword in guess_keywords:
        if keyword in user_input:
            # æå–ç©å®¶çŒœæµ‹çš„åå­—
            for suspect in suspects:
                if suspect["name"] in user_input:
                    if suspect["name"] == murderer_name:
                        print("\nğŸ¯ æ­å–œä½ ï¼çœŸå‡¶ç¡®å®æ˜¯" + murderer_name + "ï¼ä½ æˆåŠŸç ´æ¡ˆäº†ï¼")
                        print("=" * 60)
                        print("ğŸ‰ æ¸¸æˆèƒœåˆ©ï¼")
                        print("=" * 60)
                        game_over = True
                        break
                    else:
                        print(f"\nâŒ ä¸å¯¹ï¼Œ{suspect['name']}ä¸æ˜¯çœŸå‡¶ã€‚ç»§ç»­è°ƒæŸ¥å§ã€‚\n")
                    break
            if game_over:
                break
        if game_over:
            break

# ========== æ¸¸æˆç»“æŸåçš„ä¿¡æ¯ ==========
if game_over:
    print(f"\nçœŸå‡¶ï¼š{murderer_name}")
    print(f"çœŸå‡¶çš„å®Œæ•´ä¿¡æ¯ï¼š{murderer['description']}")
    print(f"çœŸå‡¶çš„æ€§æ ¼ç‰¹ç‚¹ï¼š{murderer['personality']}\n")
